# from rest_framework.generics import ListAPIView
# from rest_framework import permissions
from rest_framework.serializers import Serializer
from rest_framework.views import APIView
from rest_framework.parsers import MultiPartParser, FormParser
from rest_framework.response import Response
from rest_framework import status
from .models import FileUpload
from files_data.models import FilesData
from .serializers import FileUploadSerializer
from rest_framework import permissions
from rest_framework.generics import ListAPIView, GenericAPIView
import pandas as pd
import json
from django.core.files.storage import default_storage

class UploadedFilesView(APIView):
    parser_classes = (MultiPartParser, FormParser)

    def get(self, request, *args, **kwargs):
        files = FileUpload.objects.all()
        serializer = FileUploadSerializer(files, many=True)
        return Response(serializer.data)
    
    def post(self, request, *args, **kwargs):
        permission_classes = (permissions.IsAuthenticated, )
        files_serializer = FileUploadSerializer(data=request.data)
        upload_data = request.data
        uploaded_file = upload_data.__getitem__('docfile')
        df = pd.read_excel(uploaded_file, sheet_name='DB Scan Internne All')
        files_data = list(FilesData.objects.all())
        row_iter = df.iterrows()
        objs = [
            FilesData(
                scan = row['Scan'],
                ip_port_vuln = row['IP/Port/Vuln'],
                date_de_scan = row['Date de scan'],
                asset_ip_address = row['Asset IP Address'],
                ip_prive = row['IP Privé'],
                field_5 = row['5 Field'],
                groupe = row['Groupe'],
                owner = row['Owner'],
                status = row['Status'],
                feedback = row['Feedback'],
                field_t = row['T'],
                si = row['SI'],
                si_ref = row['SI REF'],
                role = row['Role'],
                asset_names = row['Asset Names'],
                asset_os_name = row['Asset OS Name'],
                asset_os_version = row['Asset OS Version'],
                service_port = row['Service Port'],
                service_name = row['Service Name'],
                service_product = row['Service Product'],
                vulnerability_severity_level = row['Vulnerability Severity Level'],
                severity = row['Severity'],
                vulnerability_iD = row['Vulnerability ID'],
                vulnerability_title = row['Vulnerability Title'],
                vulnerability_description = row['Vulnerability Description'],
                vulnerability_solution = row['Vulnerability Solution'],
                vulnerability_proof = row['Vulnerability Proof'],
                vulnerability_additional_urls = row['Vulnerability Additional URLs'],
                vulnerability_cve_ids = row['Vulnerability CVE IDs'],
                vulnerability_cve_urls = row['Vulnerability CVE URLs'],
                vulnerability_published_date = row['Vulnerability Published Date'],
                vulnerability_test_result_code = row['Vulnerability Test Result Code'],
                exploit_count = row['Exploit Count'],
                exploit_minimum_skill = row['Exploit Minimum Skill'],
                exploit_urls = row['Exploit URLs'],
                action_a_performer  = row['Action à Performer '],
                status_actuel  = row['Status Actuel '],
                date_clos  = row[' Date Clos'],
                date_execution_operation  = row['Date execution opération '],
                comentaire_resolution  = row['Comentaire Résolution '],
                vulnerability_age = row['Vulnerability Age'],
                check_statu_actuel_2 = row['Chek Statu Actuel2'],
                scan_period = row['Scan period'],
                figure_de_pa_pbsol = row['Figure de PA Obsol'],
                check_status_filtered = row['check Status filtred'],
                check_resolutio = row['chek resolutio'],
                si_2 = row['SI 2'],
                checker = row['checker']
            )
            for index, row in row_iter
        ]
        if not files_data:
            FilesData.objects.bulk_create(objs)
        else:
            FilesData.objects.all().delete()
            FilesData.objects.bulk_create(objs)
        if files_serializer.is_valid():
            files_serializer.save()
            return Response(files_serializer.data, status=status.HTTP_201_CREATED)
        else:
            print('error', files_serializer.errors)
            return Response(files_serializer.errors, status=status.HTTP_400_BAD_REQUEST)

class Statuts_Non_filtres(GenericAPIView):
    parser_classes = (MultiPartParser, FormParser)

    def get(self, request, format=None):
        files_data = FilesData.objects.values()
        print("*****************************")
        df = pd.DataFrame(files_data)
        status_non_filtered = pd.crosstab(df['status_actuel'], df['scan'], margins=True, margins_name='Total').sort_values(by=df.scan[0], ascending=False)
        #Total sum per column: 
        status_non_filtered.loc['Scan',:] = status_non_filtered.columns
        #Total sum per row: 
        status_non_filtered.loc[:,'Statuts'] = status_non_filtered.index
        cols = status_non_filtered.columns.tolist()
        cols = cols[-1:] + cols[:-1]
        status_non_filtered = status_non_filtered[cols]
        print(status_non_filtered)
        print("*****************************")
        return Response(status_non_filtered.values.tolist())

class Avancement_Global_SI(GenericAPIView):
    parser_classes = (MultiPartParser, FormParser)

    def get(self, request, format=None):
        files_data = FilesData.objects.values()
        print("*****************************")
        df = pd.DataFrame(files_data)
        status_non_filtered = pd.crosstab(df['status_actuel'], df['scan'], margins=True, margins_name='Total').sort_values(by=df.scan[0], ascending=False)
        #Total sum per column: 
        status_non_filtered.loc['Scan',:] = status_non_filtered.columns
        #Total sum per row: 
        status_non_filtered.loc[:,'Statuts'] = status_non_filtered.index
        cols = status_non_filtered.columns.tolist()
        cols = cols[-1:] + cols[:-1]
        status_non_filtered = status_non_filtered[cols]
        print(status_non_filtered)
        print("*****************************")
        return Response(status_non_filtered.values.tolist())
