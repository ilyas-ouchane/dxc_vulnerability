# from rest_framework.generics import ListAPIView
# from rest_framework import permissions
from rest_framework.serializers import Serializer
from rest_framework.views import APIView
from rest_framework.parsers import MultiPartParser, FormParser
from rest_framework.response import Response
from rest_framework import status
from .models import FileUpload
from files_data.models import FilesData
from external_files_data.models import ExternalFilesData
from .serializers import FileUploadSerializer
from rest_framework import permissions
from rest_framework.generics import ListAPIView, GenericAPIView
import pandas as pd
import calendar
from django.core.files.storage import default_storage

#Internal Scan

class UploadedFilesView(APIView):
    parser_classes = (MultiPartParser, FormParser)

    def get(self, request, *args, **kwargs):
        files = FileUpload.objects.all()
        serializer = FileUploadSerializer(files, many=True)
        return Response(serializer.data)
    
    def post(self, request, *args, **kwargs):
        permission_classes = (permissions.IsAuthenticated, )
        files_serializer = FileUploadSerializer(data=request.data)
        upload_data = request.data
        uploaded_file = upload_data.__getitem__('docfile')
        try: 
            df = pd.read_excel(uploaded_file, sheet_name='DB Scan Internne All')
            row_iter = df.iterrows()
            internal_objs = [
            FilesData(
                scan = row['Scan'],
                ip_port_vuln = row['IP/Port/Vuln'],
                date_de_scan = row['Date de scan'],
                asset_ip_address = row['Asset IP Address'],
                ip_prive = row['IP Privé'],
                field_5 = row[5],
                groupe = row['Groupe'],
                owner = row['Owner'],
                status = row['Status'],
                feedback = row['Feedback'],
                field_t = row['T'],
                si = row['SI'],
                si_ref = row['SI REF'],
                role = row['Role'],
                asset_names = row['Asset Names'],
                asset_os_name = row['Asset OS Name'],
                asset_os_version = row['Asset OS Version'],
                service_port = row['Service Port'],
                service_name = row['Service Name'],
                service_product = row['Service Product'],
                vulnerability_severity_level = row['Vulnerability Severity Level'],
                severity = row['Severity'],
                vulnerability_iD = row['Vulnerability ID'],
                vulnerability_title = row['Vulnerability Title'],
                vulnerability_description = row['Vulnerability Description'],
                vulnerability_solution = row['Vulnerability Solution'],
                vulnerability_proof = row['Vulnerability Proof'],
                vulnerability_additional_urls = row['Vulnerability Additional URLs'],
                vulnerability_cve_ids = row['Vulnerability CVE IDs'],
                vulnerability_cve_urls = row['Vulnerability CVE URLs'],
                vulnerability_published_date = row['Vulnerability Published Date'],
                vulnerability_test_result_code = row['Vulnerability Test Result Code'],
                exploit_count = row['Exploit Count'],
                exploit_minimum_skill = row['Exploit Minimum Skill'],
                exploit_urls = row['Exploit URLs'],
                action_a_performer  = row['Action à Performer '],
                status_actuel  = row['Status Actuel '],
                date_clos  = row[' Date Clos'],
                date_execution_operation  = row['Date execution opération '],
                comentaire_resolution  = row['Comentaire Résolution '],
                vulnerability_age = row['Vulnerability Age'],
                check_statu_actuel_2 = row['Chek Statu Actuel2'],
                scan_period = row['Scan period'],
                figure_de_pa_pbsol = row['Figure de PA Obsol'],
                check_status_filtered = row['check Status filtred'],
                check_resolutio = row['chek resolutio'],
                si_2 = row['SI.1'],
                checker = row['checker']
            )
            for index, row in row_iter
        ]
        except:
            df1 = pd.read_excel(uploaded_file, sheet_name='Rpt ext Octobre')
            external_row_iter = df1.iterrows()
            external_objs = [
            ExternalFilesData(
                c_field = external_row["C"],
                asset = external_row["Asset"],
                asset_ip_address = external_row["Asset IP Address"],
                private_ip = external_row["Private IP"],
                status = external_row["Status"],
                commentaire = external_row["Commentaire"],
                asset_names = external_row["Asset Names"],
                asset_os_name = external_row["Asset OS Name"],
                asset_os_version = external_row["Asset OS Version"],
                service_port = external_row["Service Port"],
                service_name = external_row["Service Name"],
                service_product = external_row["Service Product"],
                vulnerability_severity_level = external_row["Vulnerability Severity Level"],
                sev_lvl = external_row[ "Sev LVL"],
                vulnerability_iD = external_row["Vulnerability ID"],
                vulnerability_title = external_row["Vulnerability Title"],
                vulnerability_description = external_row["Vulnerability Description"],
                vulnerability_solution = external_row["Vulnerability Solution"],
                vulnerability_proof = external_row["Vulnerability Proof"],
                vulnerability_additional_urls = external_row["Vulnerability Additional URLs"],
                vulnerability_cve_ids = external_row["Vulnerability CVE IDs"],
                vulnerability_cve_urls = external_row["Vulnerability CVE URLs"],
                vulnerability_published_date = external_row["Vulnerability Published Date"],
                vulnerability_test_result_code = external_row["Vulnerability Test Result Code"],
                exploit_count = external_row["Exploit Count"],
                exploit_minimum_skill = external_row["Exploit Minimum Skill"],
                exploit_urls = external_row["Exploit URLs"],
                vulnerability_age = external_row["Vulnerability Age"],
                action_a_performer = external_row["Action à Performer "],
                commentaire_1 = external_row["Commentaire "],
                status_actuel  = external_row["Status Actuel "],
                date_execution_du_change = external_row["Date execution du change "],
                date_clos = external_row["Date Clos "],
                Date_previsionelle_planifié_pour_traitement = external_row["Date prévisionelle Planifié Pour Traitement  "],
                date_scan_1 = external_row["Date Scan"],
                capability = external_row["Capabilité"],
                checkpoint = external_row["Checkpoint"],
                owner = external_row["Owner"],
                checkpoint_1 = external_row["Checkpoint.1"],
                owner_1 = external_row["Owner.1"],
                date_scan_2 = external_row["Date Scan.1"],
                check_fev = external_row["Check fev"],
                chk = external_row["CHK"],
                figure_de_pa_pbsol = external_row["Figure dans Le PA Obso"],
                status_actuel_2  = external_row["Statut Actuel 2"],
                check = external_row["Check "],
                check_2 = external_row["check 2"],
                ccccc = external_row["ccccc"]
            )
            for index, external_row in external_row_iter
        ]
        files_data = list(FilesData.objects.all())
        exetrnal_files_data = list(ExternalFilesData.objects.all())
        if not files_data:
            FilesData.objects.bulk_create(internal_objs)
        elif not exetrnal_files_data:
            ExternalFilesData.objects.bulk_create(external_objs)
        elif files_data:
            FilesData.objects.all().delete()
            FilesData.objects.bulk_create(internal_objs)
        else:
            ExternalFilesData.objects.all().delete()
            ExternalFilesData.objects.bulk_create(external_objs)
        if files_serializer.is_valid():
            files_serializer.save()
            return Response(status=status.HTTP_201_CREATED)
        else:
            print('error', exetrnal_files_data.errors)

class Statuts_Non_filtres_Obs_Inc(GenericAPIView):
    parser_classes = (MultiPartParser, FormParser)

    def get(self, request, format=None):
        files_data = FilesData.objects.values()
        df = pd.DataFrame(files_data)
        status_non_filtered = pd.crosstab(df['status_actuel'], df['scan'], margins=True, margins_name='Total').sort_values(by='Total', ascending=False)
        status_non_filtered1 = pd.crosstab(df['status_actuel'], df['severity'], margins=True, margins_name='Total').sort_values(by='Total', ascending=False)
        #Total sum per column: 
        status_non_filtered.loc['Scan',:] = status_non_filtered.columns
        status_non_filtered1.loc['Scan',:] = status_non_filtered1.columns
        #Total sum per row: 
        status_non_filtered.loc[:,'Statuts'] = status_non_filtered.index
        status_non_filtered1.loc[:,'Statuts'] = status_non_filtered1.index
        status_non_filtered2 = pd.merge(status_non_filtered, status_non_filtered1, on='Statuts', how='outer')
        print("TESTING")
        print(status_non_filtered2)
        print("TESTING")
        return Response(status_non_filtered2.values.tolist())

# class Severity_Statuts_Non_filtres_Obs_Inc(GenericAPIView):
#     parser_classes = (MultiPartParser, FormParser)

#     def get(self, request, format=None):
#         files_data = FilesData.objects.values()
#         df = pd.DataFrame(files_data)
#         status_non_filtered = pd.crosstab(df['status_actuel'], df['severity'], margins=True, margins_name='Total').sort_values(by='Total', ascending=False)
#         #Total sum per column: 
#         status_non_filtered.loc['Severity',:] = status_non_filtered.columns
#         #Total sum per row: 
#         status_non_filtered.loc[:,'Statuts'] = status_non_filtered.index
#         cols = status_non_filtered.columns.tolist()
#         cols = cols[-1:] + cols[:-1]
#         status_non_filtered = status_non_filtered[cols]
#         return Response(status_non_filtered.values.tolist())

class Avancement_Global_SI_Obsolescence_Inclus (GenericAPIView):
    parser_classes = (MultiPartParser, FormParser)

    def get(self, request, format=None):
        files_data = FilesData.objects.values()
        df = pd.DataFrame(files_data)

        # Avancement Global SI en Obsolescence  INCLUS #

        status_non_filtered = pd.crosstab(df['status_actuel'], df['scan'], margins=True, margins_name='Cumul').sort_values(by=df.scan[0], ascending=False)

        #VARIABLES --- Avancement Global SI en Obsolescence  INCLUS 
        total_vulnerabilites = status_non_filtered.loc['Cumul']
        vulnerabilites_fixees = status_non_filtered.loc['Fixed']
        vuln_non_traitees = total_vulnerabilites - vulnerabilites_fixees
        Taux_de_traitement = ((vulnerabilites_fixees / total_vulnerabilites) * 100).map("{:,.1f}%".format)

        status_non_filtered.loc['Volume Global des vulnérabilités détéctées',:] = total_vulnerabilites
        status_non_filtered.loc['Volume des vulnérabilités traitées à date sans filtre',:] = vulnerabilites_fixees
        status_non_filtered.loc['Volume des vulnérabilités Non Traités sans filtre',:] = vuln_non_traitees
        status_non_filtered.loc['Taux de traitement sans filtre',:] = Taux_de_traitement
        status_non_filtered.loc['Scan',:] = status_non_filtered.columns
        status_non_filtered.loc[:,'Statuts'] = status_non_filtered.index
        cols = status_non_filtered.columns.tolist()
        cols = cols[-1:] + cols[:-1]
        status_non_filtered = status_non_filtered[cols]

        return Response(status_non_filtered.values.tolist())

class Severity_Avancement_Global_SI_Obsolescence_Inclus (GenericAPIView):
    parser_classes = (MultiPartParser, FormParser)

    def get(self, request, format=None):
        files_data = FilesData.objects.values()
        df = pd.DataFrame(files_data)

        # SEVERITY #

        status_non_filtered = pd.crosstab(df['status_actuel'], df['severity'], margins=True, margins_name='Total').sort_values(by='Total', ascending=False)

        #VARIABLES --- Avancement Global SI en Obsolescence  INCLUS 
        total_vulnerabilites1 = status_non_filtered.loc['Total']
        vulnerabilites_fixees1 = status_non_filtered.loc['Fixed']
        vuln_non_traitees1 = total_vulnerabilites1 - vulnerabilites_fixees1

        status_non_filtered.loc['Volume Global des vulnérabilités détéctées',:] = total_vulnerabilites1
        status_non_filtered.loc['Volume des vulnérabilités traitées à date sans filtre',:] = vulnerabilites_fixees1
        status_non_filtered.loc['Volume des vulnérabilités Non Traités sans filtre',:] = vuln_non_traitees1
        status_non_filtered.loc['Severity',:] = status_non_filtered.columns
        # status_non_filtered.loc[:,'Statuts'] = status_non_filtered.index
        cols = status_non_filtered.columns.tolist()
        cols = cols[-1:] + cols[:-1]
        status_non_filtered = status_non_filtered[cols]
        return Response(status_non_filtered.values.tolist())

class Avancement_Global_SI_Obsolescence_Non_Inclus (GenericAPIView):
    parser_classes = (MultiPartParser, FormParser)

    def get(self, request, format=None):
        files_data = FilesData.objects.values()
        df = pd.DataFrame(files_data)
        # df1 = df[~df.figure_de_pa_pbsol.str.contains("SI traité dans le cadre de l'obsolescence")]
        df1 = df[(df['figure_de_pa_pbsol']!="SI traité dans le cadre de l'obsolescence")]
        status_non_filtered = pd.crosstab(df1['status_actuel'], df1['scan'], margins=True, margins_name='Cumul').sort_values(by=df1.scan[0], ascending=False)
        total_vulnerabilites = status_non_filtered.loc['Cumul']
        vulnerabilites_fixees = status_non_filtered.loc['Fixed']
        vuln_non_traitees = total_vulnerabilites - vulnerabilites_fixees
        Taux_de_traitement = ((vulnerabilites_fixees / total_vulnerabilites) * 100).map("{:,.1f}%".format)
        #Total sum per column: 
        status_non_filtered.loc['Volume Global des vulnérabilités détéctées  Obsolescence exclus',:] = total_vulnerabilites
        status_non_filtered.loc['Volume des vulnérabilités traitées à date sans filtre  Obsolescence exclus',:] = vulnerabilites_fixees
        status_non_filtered.loc['Volume des vulnérabilités Non Traités  Obsolescence exclus',:] = vuln_non_traitees
        status_non_filtered.loc['Taux de traitement  Obsolescence exclus',:] = Taux_de_traitement
        status_non_filtered.loc['Scan',:] = status_non_filtered.columns
        status_non_filtered.loc[:,'Statuts'] = status_non_filtered.index
        cols = status_non_filtered.columns.tolist()
        cols = cols[-1:] + cols[:-1]
        status_non_filtered = status_non_filtered[cols]
        return Response(status_non_filtered.values.tolist())

class Severity_Avancement_Global_SI_Obsolescence_Non_Inclus (GenericAPIView):
    parser_classes = (MultiPartParser, FormParser)

    def get(self, request, format=None):
        files_data = FilesData.objects.values()
        df = pd.DataFrame(files_data)
        # df1 = df[~df.figure_de_pa_pbsol.str.contains("SI traité dans le cadre de l'obsolescence")]
        df1 = df[(df['figure_de_pa_pbsol']!="SI traité dans le cadre de l'obsolescence")]

        # SEVERITY #

        status_non_filtered = pd.crosstab(df1['status_actuel'], df1['severity'], margins=True, margins_name='Total').sort_values(by='Total', ascending=False)

        #VARIABLES --- Avancement Global SI en Obsolescence  INCLUS 
        total_vulnerabilites1 = status_non_filtered.loc['Total']
        vulnerabilites_fixees1 = status_non_filtered.loc['Fixed']
        vuln_non_traitees1 = total_vulnerabilites1 - vulnerabilites_fixees1

        status_non_filtered.loc['Volume Global des vulnérabilités détéctées',:] = total_vulnerabilites1
        status_non_filtered.loc['Volume des vulnérabilités traitées à date sans filtre',:] = vulnerabilites_fixees1
        status_non_filtered.loc['Volume des vulnérabilités Non Traités sans filtre',:] = vuln_non_traitees1
        status_non_filtered.loc['Severity',:] = status_non_filtered.columns
        # status_non_filtered.loc[:,'Statuts'] = status_non_filtered.index
        cols = status_non_filtered.columns.tolist()
        cols = cols[-1:] + cols[:-1]
        status_non_filtered = status_non_filtered[cols]
        return Response(status_non_filtered.values.tolist())

class Volume_Vulnerabilites_Non_Traites (GenericAPIView):
    parser_classes = (MultiPartParser, FormParser)

    def get(self, request, format=None):
        files_data = FilesData.objects.values()
        df = pd.DataFrame(files_data)
        df1 = df.drop_duplicates()
        df2 = df1[(df1['figure_de_pa_pbsol']!="SI traité dans le cadre de l'obsolescence") & (df1['status_actuel']!='Fixed')]
        status_non_filtered = pd.crosstab(df2['status_actuel'], df2['scan'], margins=True, margins_name='Total').sort_values(by='Total', ascending=False)

        df3 = df1[(df1['figure_de_pa_pbsol']!="SI traité dans le cadre de l'obsolescence") & (df1['status_actuel']!='Fixed')]
        status_non_filtered1 = pd.crosstab(df3['status_actuel'], df3['severity'], margins=True, margins_name='Total').sort_values(by='Total', ascending=False)
        
        status_non_filtered.loc["Non Traité > SI nécessitant le contrat de support / intervention de l'éditeur ",:] = status_non_filtered.loc["Relais Mail Nécessite l'accompagnement du préstataire(intelcom)"] + status_non_filtered.loc["(AD)  traitement On Hold  dependences au Obsolesences "] + status_non_filtered.loc["CFT  nécessité de l'accompagnement du préstataire"] + status_non_filtered.loc["(Téléphonie) nécessité de l intervention du prestataire"] + status_non_filtered.loc["(Téléphonie)  ExpressWay Nécessité d'une certif CN.Visio"] + status_non_filtered.loc["(Mega)  nécessite l'intervention du prestataire"] + status_non_filtered.loc["Baie de stockage  nécessité de contrat de support"]
        status_non_filtered.loc["Non Traité > encours d'investigation / planification",:] = status_non_filtered.loc["Not Fixed"]
        status_non_filtered.loc['Non Traité > Vulnérabilité transférés au Arl des filiales CDG',:] = status_non_filtered.loc["ERP Madaeef transféré à L ARL madaeef"] + status_non_filtered.loc["Site Web CGI Transférer à La CGI pour Traitement"]
        status_non_filtered.loc['Volume des vulnérabilités Non Traités',:] = status_non_filtered.columns
        status_non_filtered.loc[:,'Statuts'] = status_non_filtered.index
        
        
        status_non_filtered1.loc["Non Traité > SI nécessitant le contrat de support / intervention de l'éditeur ",:] = status_non_filtered1.loc["Relais Mail Nécessite l'accompagnement du préstataire(intelcom)"] + status_non_filtered1.loc["(AD)  traitement On Hold  dependences au Obsolesences "] + status_non_filtered1.loc["CFT  nécessité de l'accompagnement du préstataire"] + status_non_filtered1.loc["(Téléphonie) nécessité de l intervention du prestataire"] + status_non_filtered1.loc["(Téléphonie)  ExpressWay Nécessité d'une certif CN.Visio"] + status_non_filtered1.loc["(Mega)  nécessite l'intervention du prestataire"] + status_non_filtered1.loc["Baie de stockage  nécessité de contrat de support"]
        status_non_filtered1.loc["Non Traité > encours d'investigation / planification",:] = status_non_filtered1.loc["Not Fixed"]
        status_non_filtered1.loc['Non Traité > Vulnérabilité transférés au Arl des filiales CDG',:] = status_non_filtered1.loc["ERP Madaeef transféré à L ARL madaeef"] + status_non_filtered1.loc["Site Web CGI Transférer à La CGI pour Traitement"]
        status_non_filtered1.loc['Volume des vulnérabilités Non Traités',:] = status_non_filtered1.columns
        status_non_filtered1.loc[:,'Statuts'] = status_non_filtered1.index
        # cols = status_non_filtered.columns.tolist()
        # cols = cols[-1:] + cols[:-1]
        # status_non_filtered = status_non_filtered[cols]
        status_non_filtered2 = pd.merge(status_non_filtered, status_non_filtered1, on='Statuts', how='outer')
        print("TESTING")
        print(status_non_filtered2)
        print("TESTING")
        return Response(status_non_filtered2.values.tolist())

class Severity_Volume_Vulnerabilites_Non_Traites (GenericAPIView):
    parser_classes = (MultiPartParser, FormParser)

    def get(self, request, format=None):
        files_data = FilesData.objects.values()
        df = pd.DataFrame(files_data)
        df1 = df.drop_duplicates()

        # SEVERITY #

        df2 = df1[(df1['figure_de_pa_pbsol']!="SI traité dans le cadre de l'obsolescence") & (df1['status_actuel']!='Fixed')]
        status_non_filtered = pd.crosstab(df2['status_actuel'], df2['severity'], margins=True, margins_name='Total').sort_values(by='Total', ascending=False)
        status_non_filtered.loc["Non Traité > SI nécessitant le contrat de support / intervention de l'éditeur ",:] = status_non_filtered.loc["Relais Mail Nécessite l'accompagnement du préstataire(intelcom)"] + status_non_filtered.loc["(AD)  traitement On Hold  dependences au Obsolesences "] + status_non_filtered.loc["CFT  nécessité de l'accompagnement du préstataire"] + status_non_filtered.loc["(Téléphonie) nécessité de l intervention du prestataire"] + status_non_filtered.loc["(Téléphonie)  ExpressWay Nécessité d'une certif CN.Visio"] + status_non_filtered.loc["(Mega)  nécessite l'intervention du prestataire"] + status_non_filtered.loc["Baie de stockage  nécessité de contrat de support"]
        status_non_filtered.loc["Non Traité > encours d'investigation / planification",:] = status_non_filtered.loc["Not Fixed"]
        status_non_filtered.loc['Non Traité > Vulnérabilité transférés au Arl des filiales CDG',:] = status_non_filtered.loc["ERP Madaeef transféré à L ARL madaeef"] + status_non_filtered.loc["Site Web CGI Transférer à La CGI pour Traitement"]
        status_non_filtered.loc['Volume des vulnérabilités Non Traités',:] = status_non_filtered.columns
        status_non_filtered.loc[:,'Statuts'] = status_non_filtered.index
        cols = status_non_filtered.columns.tolist()
        cols = cols[-1:] + cols[:-1]
        status_non_filtered = status_non_filtered[cols]
        return Response(status_non_filtered.values.tolist())

#External Scan

class Ext_SI_En_obso_inclus(GenericAPIView):
    parser_classes = (MultiPartParser, FormParser)

    def get(self, request, format=None):
        files_data = ExternalFilesData.objects.values()
        df = pd.DataFrame(files_data)
        status_non_filtered = pd.crosstab(df['status_actuel_2'], df['date_scan_1'], margins=True, margins_name='Total').sort_values(by='Total', ascending=False)
        #Elimination du timestamps des colonnes 
        status_non_filtered.rename(columns=lambda x: x[:10], inplace=True)
        #Unifiormer les dates  
        status_non_filtered.rename(columns=lambda x: x.replace("/", "-"), inplace=True)
        status_non_filtered1 = pd.crosstab(df['status_actuel_2'], df['sev_lvl'], margins=True, margins_name='Total').sort_values(by='Total', ascending=False)
        status_non_filtered1.rename(columns=lambda x: x[:10], inplace=True)
        #Total sum per column: 
        status_non_filtered1.loc['Scan',:] = status_non_filtered1.columns
        status_non_filtered.loc['Scan',:] = status_non_filtered.columns
        #Total sum per row: 
        status_non_filtered.loc[:,'Statuts'] = status_non_filtered.index
        status_non_filtered1.loc[:,'Statuts'] = status_non_filtered1.index
        status_non_filtered2 = pd.merge(status_non_filtered, status_non_filtered1, on='Statuts', how='outer')
        # cols = status_non_filtered.columns.tolist()
        # cols = cols[-1:] + cols[:-1]
        # status_non_filtered = status_non_filtered[cols]
        return Response(status_non_filtered2.values.tolist())

# class Ext_Sev_SI_En_obso_inclus(GenericAPIView):
#     parser_classes = (MultiPartParser, FormParser)

#     def get(self, request, format=None):
#         files_data = ExternalFilesData.objects.values()
#         df = pd.DataFrame(files_data)
#         status_non_filtered = pd.crosstab(df['status_actuel_2'], df['sev_lvl'], margins=True, margins_name='Total').sort_values(by='Total', ascending=False)
#         status_non_filtered.rename(columns=lambda x: x[:10], inplace=True)
#         #Total sum per column: 
#         status_non_filtered.loc['Scan',:] = status_non_filtered.columns
#         #Total sum per row: 
#         status_non_filtered.loc[:,'Statuts'] = status_non_filtered.index
#         cols = status_non_filtered.columns.tolist()
#         cols = cols[-1:] + cols[:-1]
#         status_non_filtered = status_non_filtered[cols]
#         return Response(status_non_filtered.values.tolist())

# class Int_Volumetrie(GenericAPIView):
#     parser_classes = (MultiPartParser, FormParser)

#     def get(self, request, format=None):
#         files_data = FilesData.objects.values()
#         df = pd.DataFrame(files_data)
#         status_non_filtered = pd.crosstab(df['status_actuel'], df['scan'], margins=True, margins_name='Total').sort_values(by='Total', ascending=False)
#         #Total sum per column: 
#         status_non_filtered.loc['Scan',:] = status_non_filtered.columns
#         #Total sum per row: 
#         status_non_filtered.loc[:,'Statuts'] = status_non_filtered.index
#         return Response(status_non_filtered.values.tolist())

class Ext_Avancement_Global_SI_Obsolescence_Inclus (GenericAPIView):
    parser_classes = (MultiPartParser, FormParser)

    def get(self, request, format=None):
        files_data = ExternalFilesData.objects.values()
        df = pd.DataFrame(files_data)

        # Avancement Global SI en Obsolescence  INCLUS #

        status_non_filtered = pd.crosstab(df['status_actuel_2'], df['date_scan_1'], margins=True, margins_name='Total').sort_values(by='Total', ascending=False)
        #Elimination du timestamps des colonnes 
        status_non_filtered.rename(columns=lambda x: x[:10], inplace=True)
        #Unifiormer les dates  
        status_non_filtered.rename(columns=lambda x: x.replace("/", "-"), inplace=True)

        #VARIABLES --- Avancement Global SI en Obsolescence  INCLUS 
        total_vulnerabilites = status_non_filtered.loc['Total']
        vulnerabilites_fixees = status_non_filtered.loc['Fixed']
        vuln_non_traitees = total_vulnerabilites - vulnerabilites_fixees
        Taux_de_traitement = ((vulnerabilites_fixees / total_vulnerabilites) * 100).map("{:,.1f}%".format)

        status_non_filtered.loc['Volume des nouvelles vulnérabilités détéctées',:] = total_vulnerabilites
        status_non_filtered.loc['Volume des vulnérabilités traitées par scan à date',:] = vulnerabilites_fixees
        status_non_filtered.loc['Volume des vulnérabilités Non Traités',:] = vuln_non_traitees
        status_non_filtered.loc['Taux de traitement du volume traité par scan',:] = Taux_de_traitement
        status_non_filtered.loc['Scan',:] = status_non_filtered.columns
        status_non_filtered.loc[:,'Statuts'] = status_non_filtered.index
        cols = status_non_filtered.columns.tolist()
        cols = cols[-1:] + cols[:-1]
        status_non_filtered = status_non_filtered[cols]
        return Response(status_non_filtered.values.tolist())

class Ext_Severity_Avancement_Global_SI_Obsolescence_Inclus (GenericAPIView):
    parser_classes = (MultiPartParser, FormParser)

    def get(self, request, format=None):
        files_data = ExternalFilesData.objects.values()
        df = pd.DataFrame(files_data)

        # SEVERITY #

        status_non_filtered = pd.crosstab(df['status_actuel_2'], df['sev_lvl'], margins=True, margins_name='Total').sort_values(by='Total', ascending=False)
        #Elimination du timestamps des colonnes 
        status_non_filtered.rename(columns=lambda x: x[:10], inplace=True)
        #Unifiormer les dates  
        status_non_filtered.rename(columns=lambda x: x.replace("/", "-"), inplace=True)
        #VARIABLES --- Avancement Global SI en Obsolescence  INCLUS 
        total_vulnerabilites1 = status_non_filtered.loc['Total']
        vulnerabilites_fixees1 = status_non_filtered.loc['Fixed']
        vuln_non_traitees1 = total_vulnerabilites1 - vulnerabilites_fixees1

        status_non_filtered.loc['Volume Global des vulnérabilités détéctées',:] = total_vulnerabilites1
        status_non_filtered.loc['Volume des vulnérabilités traitées à date sans filtre',:] = vulnerabilites_fixees1
        status_non_filtered.loc['Volume des vulnérabilités Non Traités sans filtre',:] = vuln_non_traitees1
        status_non_filtered.loc['Severity',:] = status_non_filtered.columns
        # status_non_filtered.loc[:,'Statuts'] = status_non_filtered.index
        cols = status_non_filtered.columns.tolist()
        cols = cols[-1:] + cols[:-1]
        status_non_filtered = status_non_filtered[cols]
        return Response(status_non_filtered.values.tolist())

class Ext_Avancement_Global_SI_Obsolescence_Non_Inclus (GenericAPIView):
    parser_classes = (MultiPartParser, FormParser)

    def get(self, request, format=None):
        files_data = ExternalFilesData.objects.values()
        df = pd.DataFrame(files_data)
        # df1 = df[~df.figure_de_pa_pbsol.str.contains("SI traité dans le cadre de l'obsolescence")]
        df1 = df[(df['figure_de_pa_pbsol']!="Yes")]
        status_non_filtered = pd.crosstab(df1['status_actuel_2'], df1['date_scan_1'], margins=True, margins_name='Cumul').sort_values(by='Cumul', ascending=False)
        #Elimination du timestamps des colonnes 
        status_non_filtered.rename(columns=lambda x: x[:10], inplace=True)
        #Unifiormer les dates  
        status_non_filtered.rename(columns=lambda x: x.replace("/", "-"), inplace=True)
        total_vulnerabilites = status_non_filtered.loc['Cumul']
        vulnerabilites_fixees = status_non_filtered.loc['Fixed']
        vuln_non_traitees = total_vulnerabilites - vulnerabilites_fixees
        Taux_de_traitement = ((vulnerabilites_fixees / total_vulnerabilites) * 100).map("{:,.1f}%".format)
        #Total sum per column: 
        status_non_filtered.loc['Volume Global des vulnérabilités détéctées',:] = total_vulnerabilites
        status_non_filtered.loc['Volume des vulnérabilités traitées par scan à date',:] = vulnerabilites_fixees
        status_non_filtered.loc['Volume des vulnérabilités non traités',:] = vuln_non_traitees
        status_non_filtered.loc['Taux de traitement du volume traité par scan',:] = Taux_de_traitement
        status_non_filtered.loc['Scan',:] = status_non_filtered.columns
        status_non_filtered.loc[:,'Statuts'] = status_non_filtered.index
        cols = status_non_filtered.columns.tolist()
        cols = cols[-1:] + cols[:-1]
        status_non_filtered = status_non_filtered[cols]
        return Response(status_non_filtered.values.tolist())

class Ext_Severity_Avancement_Global_SI_Obsolescence_Non_Inclus (GenericAPIView):
    parser_classes = (MultiPartParser, FormParser)

    def get(self, request, format=None):
        files_data = ExternalFilesData.objects.values()
        df = pd.DataFrame(files_data)
        df1 = df[(df['figure_de_pa_pbsol']!="Yes")]

        # SEVERITY #

        status_non_filtered = pd.crosstab(df1['status_actuel_2'], df1['sev_lvl'], margins=True, margins_name='Total').sort_values(by='Total', ascending=False)
        #Elimination du timestamps des colonnes 
        status_non_filtered.rename(columns=lambda x: x[:10], inplace=True)
        #Unifiormer les dates  
        status_non_filtered.rename(columns=lambda x: x.replace("/", "-"), inplace=True)
        #VARIABLES --- Avancement Global SI en Obsolescence  INCLUS 
        total_vulnerabilites1 = status_non_filtered.loc['Total']
        vulnerabilites_fixees1 = status_non_filtered.loc['Fixed']
        vuln_non_traitees1 = total_vulnerabilites1 - vulnerabilites_fixees1

        status_non_filtered.loc['Volume Global des vulnérabilités détéctées',:] = total_vulnerabilites1
        status_non_filtered.loc['Volume des vulnérabilités traitées à date sans filtre',:] = vulnerabilites_fixees1
        status_non_filtered.loc['Volume des vulnérabilités Non Traités sans filtre',:] = vuln_non_traitees1
        status_non_filtered.loc['Severity',:] = status_non_filtered.columns
        # status_non_filtered.loc[:,'Statuts'] = status_non_filtered.index
        cols = status_non_filtered.columns.tolist()
        cols = cols[-1:] + cols[:-1]
        status_non_filtered = status_non_filtered[cols]
        return Response(status_non_filtered.values.tolist())

#Dashboard 

class Int_Volumetrie(GenericAPIView):
    parser_classes = (MultiPartParser, FormParser)

    def get(self, request, format=None):
        files_data = FilesData.objects.values()
        df = pd.DataFrame(files_data)
        status_non_filtered = pd.crosstab(df['status_actuel']== 'Fixed', df['scan'], margins=True, margins_name='Total').sort_values(by='Total', ascending=False)
        #Total sum per column: 
        status_non_filtered.loc['Scan',:] = status_non_filtered.columns
        #Total sum per row: 
        # status_non_filtered.loc[:,'Statuts'] = status_non_filtered.index
        return Response(status_non_filtered.values.tolist())

