import React, { useState } from 'react'
import axios from 'axios'
import {
  CCard,
  CCardBody,
  CCardFooter,
  CCardHeader,
  CCol,
  CCollapse,
  CFade,
  CInput,
  CInputFile,
  CInputGroup,
  CInputGroupAppend,
  CInputGroupPrepend,
  CInputGroupText,
  CButton,
  CForm,
  CFormGroup,
  CBadge,
  CLabel,
  CRow,
  CProgress,
  CAlert
} from '@coreui/react'

const Upload = () => {

  const [docfile, setDocFile] = useState();
  const [remarque, setRemarque] = useState();
  const [axios_status, setAxiosStatus] = useState();
  const [progress, setProgress] = useState(0);

  const config = {
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('token')}`,
      'Content-Type': 'multipart/form-data'
    },

    onUploadProgress: (ProgressEvent) => {
      const {loaded, total} = ProgressEvent
      let percent = Math.floor( (loaded * 100) / total )
      console.log(`${loaded} kb of ${total} kb | ${percent}%`)

      if( percent < 100) {
        setProgress(percent)
      }
    }
  };

  const submitForm = (event) => {
    event.preventDefault();

    const dataArray = new FormData();
    const user_id = localStorage.getItem('user_id')
    console.log("The user id :",user_id)
    dataArray.append("uploaded_by", user_id);
    dataArray.append("remarque", remarque);
    try {
      dataArray.append("docfile", docfile[0]);
    } catch (error) {
      alert('Please insert a file !')
    }
    

    axios
      .post("http://localhost:8000/api/files_upload/upload/", dataArray, config)
      .then((response) => {
        setAxiosStatus(response)
        console.log(response)
        setProgress(100)
      })
      .catch((error) => {
        setAxiosStatus(error)
        alert('Please insert an excel format!')
        console.log(error)
      });
  };

  const [collapsed, setCollapsed] = React.useState(true)
  const [showElements, setShowElements] = React.useState(true)

  return (
    <>
      <CRow>
        <CCol xs="12">
          <CFade timeout={300} in={showElements} unmountOnExit={true}>
            <CCard>
              <CCardHeader>
              File Upload
              </CCardHeader>
              <CCollapse show={collapsed} timeout={1000}>
                <CCardBody>
                  <CForm onSubmit={submitForm} className="form-horizontal">
                    <CFormGroup>
                      <CLabel htmlFor="prependedInput">Upload your File</CLabel>
                      <div className="controls">
                        <CInputGroup className="input-prepend">
                        <CInputFile custom id="custom-file-input" onChange={(e) => setDocFile(e.target.files)}/>
                        <CLabel htmlFor="custom-file-input" variant="custom-file">
                            { docfile
                            ?
                            <p>{docfile[0].name}</p>
                            :
                            <p>Choose file...</p>
                          }
                        </CLabel>
                        </CInputGroup>
                      </div>
                    </CFormGroup>
                    <CFormGroup>
                      <CLabel htmlFor="appendedInput">Remarque</CLabel>
                      <div className="controls">
                        <CInputGroup>
                        <CInput 
                          type="text" 
                          name="remarque"
                          placeholder="Remarque" 
                          onChange={(e) => setRemarque(e.target.value)}
                        />
                        </CInputGroup>
                      </div>
                    </CFormGroup>
                    <CCol xs="12" sm="6" md="4">
                      <CCard>
                        <CCardHeader>
                          Uploaded File Status
                          <div className="card-header-actions">
                          { docfile
                            ?
                            <CBadge color="success" className="float-right">Success</CBadge>
                            :
                            <CBadge shape="pill" color="danger" className="float-right">Fail</CBadge>
                          }
                          </div>
                        </CCardHeader>
                        <CCardBody>
                          Nom du fichier : { docfile
                            ?
                            <>{docfile[0].name}</>
                            :
                            <CBadge color="fail" className="float-right">Aucun Fichier n'est choisi</CBadge> }
                        </CCardBody>
                      </CCard>
                    </CCol>
                    <CCard>
                      <CCardHeader>
                        Progress
                      </CCardHeader>
                      <CCardBody>
                        <CProgress value={progress} max={100} showPercentage className="mb-3"/>
                      </CCardBody>
                    </CCard>
                    <div className="form-actions">
                      <CButton type="submit" color="primary">Save changes</CButton>
                      {/* {axios_status.response.status == 500? <CAlert color="warning">La a sahbi la</CAlert>:<CAlert color="success">Ah a sahbi Ah</CAlert> } */}
                      <CButton type="reset" color="secondary">Cancel</CButton>
                    </div>
                  </CForm>
                </CCardBody>
              </CCollapse>
            </CCard>
          </CFade>
        </CCol>
      </CRow>
    </>
  )
}

export default Upload
