import React, { lazy, useState, useEffect } from 'react'
import axios from 'axios'
import {
  CBadge,
  CButton,
  CButtonGroup,
  CCard,
  CCardBody,
  CCardFooter,
  CCardHeader,
  CCol,
  CProgress,
  CRow,
  CCallout,
  CCardGroup,
  CWidgetProgress,
  CCollapse
} from '@coreui/react'
import {
  CChartPie,
  CChartPolarArea,
  CChartDoughnut,
  CChartBar
} from '@coreui/react-chartjs'
import CIcon from '@coreui/icons-react'

import MainChartExample from '../charts/MainChartExample.js'

const WidgetsDropdown = lazy(() => import('../widgets/WidgetsDropdown.js'))
const WidgetsBrand = lazy(() => import('../widgets/WidgetsBrand.js'))

const Dashboard = () => {

  const [int_status_non_filtres, setStatNonFiltre] = useState([])
  const [ext_status_non_filtres, setExtStatNonFiltre] = useState([])
  const [int_volumetrie, setIntVolumetrie] = useState([])
  const [ext_volumetrie, setintVolumetrie] = useState([])
  const [accordion, setAccordion] = useState(1)

  useEffect(async () => {
    
    const config = {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`,
        'Content-Type': 'multipart/form-data'
      }
    };

    const res = await axios('http://localhost:8000/api/files_upload/statuts_non_filtres_obc_inc/',config)
    res.data.lastItem = res.data.lastItem.map(v => v.toLowerCase())
    setStatNonFiltre(res.data)
    
    const res1 = await axios('http://localhost:8000/api/files_upload/ext_si_en_obso_inclus/',config)
    res1.data.lastItem = res1.data.lastItem.map(v => v.toLowerCase())
    setExtStatNonFiltre(res1.data)

    const res2 = await axios('http://localhost:8000/api/files_upload/ext_volumetrie/',config)
    res2.data.lastItem = res2.data.lastItem.map(v => v.toLowerCase())
    setintVolumetrie(res2.data)

    const res3 = await axios('http://localhost:8000/api/files_upload/int_volumetrie/',config)
    res3.data.lastItem = res3.data.lastItem.map(v => v.toLowerCase())
    setIntVolumetrie(res3.data)

  }, [])
  
  //filesData
  const filesData_int_volumetrie = []
  const filesData_ext_volumetrie = []
  
  //charts fields
  const charts_filesData_int_volumetrie = []
  const charts_filesData_ext_volumetrie = []
  
  //fields
  const fields_int_volumetrie = int_volumetrie.lastItem
  const fields_ext_volumetrie = ext_volumetrie.lastItem
  try {
    delete fields_int_volumetrie.pop()
    delete fields_ext_volumetrie.pop()
  } catch (error) {
    
  }

  //Adding API data to fieldsData

  try {
    var total_int_status_non_filtres = int_status_non_filtres[0][int_status_non_filtres[0].length -1 ]
    var fixed_int_status_non_filtres = int_status_non_filtres[1][int_status_non_filtres[1].length -1 ]
    var total_ext_status_non_filtres = ext_status_non_filtres[0][ext_status_non_filtres[0].length -1 ]
    var fixed_ext_status_non_filtres = ext_status_non_filtres[1][ext_status_non_filtres[1].length -1 ]
  } catch (error) {
    
  }

  // progress_int_status_non_filtres = (fixed_int_status_non_filtres*100)/total_int_status_non_filtres
  var progress_int_status_non_filtres = (Math.round(fixed_int_status_non_filtres*100)/total_int_status_non_filtres).toFixed(2)
  var progress_ext_status_non_filtres = (Math.round(fixed_ext_status_non_filtres*100)/total_ext_status_non_filtres).toFixed(2)
  
  for (let i in int_volumetrie) {
    filesData_int_volumetrie[i] = { ...int_volumetrie[i] }
  }

  for (let i in ext_volumetrie) {
    filesData_ext_volumetrie[i] = { ...ext_volumetrie[i] }
  }

  
  
  //Charts for Volumetrie Interne

  for (let i in filesData_int_volumetrie) {
    charts_filesData_int_volumetrie[i] = Object.values(filesData_int_volumetrie[i])
    charts_filesData_int_volumetrie[i].pop()
  }
  delete charts_filesData_int_volumetrie.splice(-1)

  for (let i in filesData_ext_volumetrie) {
    charts_filesData_ext_volumetrie[i] = Object.values(filesData_ext_volumetrie[i])
    charts_filesData_ext_volumetrie[i].pop()
  }
  delete charts_filesData_ext_volumetrie.splice(-1)

  try {
    charts_filesData_int_volumetrie.splice(-1)
    charts_filesData_int_volumetrie.push(charts_filesData_int_volumetrie[0].map(function(n, i) { return (Math.round(charts_filesData_int_volumetrie[1][i]*100)/n).toFixed(0)}))
    int_filtered_data.splice(-1)
    charts_filesData_ext_volumetrie.splice(-1)
    charts_filesData_ext_volumetrie.push(charts_filesData_ext_volumetrie[0].map(function(n, i) { return (Math.round(charts_filesData_ext_volumetrie[1][i]*100)/n).toFixed(0)}))
    ext_filtered_data.splice(-1)
  } catch (error) {}

  var int_filtered_data = []
  var ext_filtered_data = []
  var volumetrie = ['Volume', 'Volume traité', '% Progress']
  var int_backgroundColor = ['#1870b9', '#f38f20', '#f7cf2b']
  var ext_backgroundColor = ['#6f2c91', '#97be35', '#f7cf2b']
  
  for (let i in charts_filesData_int_volumetrie) {
    int_filtered_data.push({data: charts_filesData_int_volumetrie[i], label: volumetrie[i], backgroundColor: int_backgroundColor[i]})
  }

  for (let i in charts_filesData_ext_volumetrie) {
    ext_filtered_data.push({data: charts_filesData_ext_volumetrie[i], label: volumetrie[i], backgroundColor: ext_backgroundColor[i]})
  }

  return (
    <>
      <CRow>
        <CCol xl="6">
          <p className="h2">Scan Interne</p>
            <CCard>
              <CCardHeader>
                Volumétrie Interne
              </CCardHeader>
              <CCardBody>
                <CChartBar
                  datasets={int_filtered_data}
                  labels={fields_int_volumetrie}
                  options={{
                    tooltips: {
                      enabled: true
                    }
                  }}
                />
              </CCardBody>
            </CCard>
            <CCard>
              <CCardHeader>
                Avancement Global Avec obsolescence Incluse
                <div className="small text-muted">Interne</div>
              </CCardHeader>
              <CCardBody>
                <CChartDoughnut
                  datasets={[
                    {
                      backgroundColor: [
                        '#1870B9',
                        '#F38F20',
                      ],
                      data: [total_int_status_non_filtres, fixed_int_status_non_filtres]
                    }
                  ]}
                  labels={[`Volume : ${total_int_status_non_filtres}`, `Volume traité: ${fixed_int_status_non_filtres}`]}
                  options={{
                    tooltips: {
                      enabled: true
                    }
                  }}
                />
                <span className="h2">{progress_int_status_non_filtres} %</span>
              </CCardBody>
            </CCard>
            <CCard>
            <CCardHeader>
              Collapse
              <small> accordion</small>
            </CCardHeader>
            <CCardBody>
              <div id="accordion">
                <CCard className="mb-0">
                  <CCardHeader id="headingOne">
                    <CButton 
                      block 
                      color="link" 
                      className="text-left m-0 p-0" 
                      onClick={() => setAccordion(accordion === 0 ? null : 0)}
                    >
                      <h5 className="m-0 p-0">Collapsible Group Item #1</h5>
                    </CButton>
                  </CCardHeader>
                  <CCollapse show={accordion === 0}>
                    <CCardBody>
                      1. Anim pariatur cliche reprehenderit, enim eiusmod high life accusamus terry richardson ad squid. 3 wolf moon officia aute, non
                      cupidatat skateboard dolor brunch. Food truck quinoa nesciunt laborum eiusmod. Brunch 3 wolf moon tempor, sunt aliqua put a bird
                      on it squid single-origin coffee nulla assumenda shoreditch et. Nihil anim keffiyeh helvetica, craft beer labore wes anderson cred
                      nesciunt sapiente ea proident. Ad vegan excepteur butcher vice lomo. Leggings occaecat craft
                      beer farm-to-table, raw denim aesthetic synth nesciunt you probably haven''t heard of them accusamus labore sustainable VHS.
                    </CCardBody>
                  </CCollapse>
                </CCard>
                <CCard className="mb-0">
                  <CCardHeader id="headingTwo">
                    <CButton 
                      block 
                      color="link" 
                      className="text-left m-0 p-0" 
                      onClick={() => setAccordion(accordion === 1 ? null : 1)}
                    >
                      <h5 className="m-0 p-0">Collapsible Group Item #2</h5>
                    </CButton>
                  </CCardHeader>
                  <CCollapse show={accordion === 1}>
                    <CCardBody>
                      2. Anim pariatur cliche reprehenderit, enim eiusmod high life accusamus terry richardson ad squid. 3 wolf moon officia aute, non
                      cupidatat skateboard dolor brunch. Food truck quinoa nesciunt laborum eiusmod. Brunch 3 wolf moon tempor, sunt aliqua put a bird
                      on it squid single-origin coffee nulla assumenda shoreditch et. Nihil anim keffiyeh helvetica, craft beer labore wes anderson cred
                      nesciunt sapiente ea proident. Ad vegan excepteur butcher vice lomo. Leggings occaecat craft
                      beer farm-to-table, raw denim aesthetic synth nesciunt you probably haven''t heard of them accusamus labore sustainable VHS.
                    </CCardBody>
                  </CCollapse>
                </CCard>
                <CCard className="mb-0">
                  <CCardHeader id="headingThree">
                    <CButton 
                      block 
                      color="link" 
                      className="text-left m-0 p-0" 
                      onClick={() => setAccordion(accordion === 2 ? null : 2)}
                    >
                      <h5 className="m-0 p-0">Collapsible Group Item #3</h5>
                    </CButton>
                  </CCardHeader>
                  <CCollapse show={accordion === 2}>
                    <CCardBody>
                      3. Anim pariatur cliche reprehenderit, enim eiusmod high life accusamus terry richardson ad squid. 3 wolf moon officia aute, non
                      cupidatat skateboard dolor brunch. Food truck quinoa nesciunt laborum eiusmod. Brunch 3 wolf moon tempor, sunt aliqua put a bird
                      on it squid single-origin coffee nulla assumenda shoreditch et. Nihil anim keffiyeh helvetica, craft beer labore wes anderson cred
                      nesciunt sapiente ea proident. Ad vegan excepteur butcher vice lomo. Leggings occaecat craft
                      beer farm-to-table, raw denim aesthetic synth nesciunt you probably havent heard of them accusamus labore sustainable VHS.
                    </CCardBody>
                  </CCollapse>
                </CCard>
              </div>
            </CCardBody>
          </CCard>
          {/* </CCardGroup> */}
        </CCol>
      
      
        <CCol xl = "6">
          <p className="h2">Scan Externe</p>
          <CCard>
            <CCardHeader>
              Volumétrie Externe
            </CCardHeader>
            <CCardBody>
              <CChartBar
                datasets={ext_filtered_data}
                labels={fields_ext_volumetrie}
                options={{
                  tooltips: {
                    enabled: true
                  }
                }}
              />
            </CCardBody>
          </CCard>
          <CCard>
            <CCardHeader>
              Avancement Global Avec obsolescence Incluse
              <div className="small text-muted">Externe</div>
            </CCardHeader>
            <CCardBody>
              <CChartDoughnut
                datasets={[
                  {
                    backgroundColor: [
                      '#6f2c91',
                      '#97be35',
                    ],
                    data: [total_ext_status_non_filtres, fixed_ext_status_non_filtres]
                  }
                ]}
                labels={[`Volume : ${total_ext_status_non_filtres}`, `Volume traité: ${fixed_ext_status_non_filtres}`]}
                options={{
                  tooltips: {
                    enabled: true
                  }
                }}
              />
              <span className="h2">{progress_ext_status_non_filtres} %</span>
            </CCardBody>
          </CCard>
        </CCol>
      </CRow>
      {/* <WidgetsDropdown /> */}
      <CCard>
        <CCardBody>
          <CRow>
            <CCol sm="5">
              <h4 id="traffic" className="card-title mb-0">Traffic</h4>
              <div className="small text-muted">November 2017</div>
            </CCol>
            <CCol sm="7" className="d-none d-md-block">
              <CButton color="primary" className="float-right">
                <CIcon name="cil-cloud-download"/>
              </CButton>
              <CButtonGroup className="float-right mr-3">
                {
                  ['Day', 'Month', 'Year'].map(value => (
                    <CButton
                      color="outline-secondary"
                      key={value}
                      className="mx-0"
                      active={value === 'Month'}
                    >
                      {value}
                    </CButton>
                  ))
                }
              </CButtonGroup>
            </CCol>
          </CRow>
          {/* <MainChartExample style={{height: '300px', marginTop: '40px'}}/> */}
        </CCardBody>
        <CCardFooter>
          <CRow className="text-center">
            <CCol md sm="12" className="mb-sm-2 mb-0">
              <div className="text-muted">Visits</div>
              <strong>29.703 Users (40%)</strong>
              <CProgress
                className="progress-xs mt-2"
                precision={1}
                color="success"
                value={40}
              />
            </CCol>
            <CCol md sm="12" className="mb-sm-2 mb-0 d-md-down-none">
              <div className="text-muted">Unique</div>
              <strong>24.093 Users (20%)</strong>
              <CProgress
                className="progress-xs mt-2"
                precision={1}
                color="info"
                value={40}
              />
            </CCol>
            <CCol md sm="12" className="mb-sm-2 mb-0">
              <div className="text-muted">Pageviews</div>
              <strong>78.706 Views (60%)</strong>
              <CProgress
                className="progress-xs mt-2"
                precision={1}
                color="warning"
                value={40}
              />
            </CCol>
            <CCol md sm="12" className="mb-sm-2 mb-0">
              <div className="text-muted">New Users</div>
              <strong>22.123 Users (80%)</strong>
              <CProgress
                className="progress-xs mt-2"
                precision={1}
                color="danger"
                value={40}
              />
            </CCol>
            <CCol md sm="12" className="mb-sm-2 mb-0 d-md-down-none">
              <div className="text-muted">Bounce Rate</div>
              <strong>Average Rate (40.15%)</strong>
              <CProgress
                className="progress-xs mt-2"
                precision={1}
                value={40}
              />
            </CCol>
          </CRow>
        </CCardFooter>
      </CCard>

    </>
  )
}

export default Dashboard
